<script>
/**
 * =================================================================
 * MODULE JAVASCRIPT - GESTION DU PANIER
 * =================================================================
 * Description: Gère l'ajout, la suppression et l'affichage des
 * tournées dans le panier du client.
 */

/**
 * Ajoute la tournée configurée au panier global.
 */
function ajouterTourneeAuPanier() {
  const { ui } = window;
  const { tourneeEnCours } = window.etat;
  const creneauSelectionneBtn = ui.grilleSelectionCreneau.querySelector('.slot-btn.selected');
  const estRecurrent = document.getElementById('interrupteur-recurrence').checked;

  if (!creneauSelectionneBtn) {
    afficherNotification("Veuillez sélectionner un créneau.", "erreur");
    return;
  }

  const nouvelleTournee = {
    id: 'tournee-' + Date.now(),
    date: tourneeEnCours.date,
    startTime: creneauSelectionneBtn.dataset.creneau,
    totalStops: tourneeEnCours.totalStops,
    returnToPharmacy: tourneeEnCours.returnToPharmacy,
    prix: parseFloat(creneauSelectionneBtn.dataset.prix),
    duree: tourneeEnCours.duree,
    details: `Tournée de ${tourneeEnCours.duree}min (${Math.max(0, tourneeEnCours.totalStops - 1)} arrêt(s) sup., retour: ${tourneeEnCours.returnToPharmacy ? 'oui' : 'non'})`,
    isRecurrent: estRecurrent // Nouvelle propriété
  };

  window.etat.panier.push(nouvelleTournee);

  afficherPanier();
  sauvegarderPanierDansLocalStorage();

  ui.modaleSelectionCreneau.classList.add('hidden');
  afficherNotification("Tournée ajoutée au panier !", "succes");
}

/**
 * Met à jour l'affichage du panier dans l'interface.
 */
function afficherPanier() {
  const { ui } = window;
  const { panier } = window.etat;

  if (panier.length === 0) {
    ui.listePanier.innerHTML = '<p class="panier-vide">Votre panier est vide.</p>';
    ui.panierPiedDePage.classList.add('hidden');
    return;
  }

  ui.listePanier.innerHTML = panier.map(item => {
    const date = new Date(item.date + 'T00:00:00');
    const dateFormatee = date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long' });
    const recurrenceInfo = item.isRecurrent ? '<small style="color: #6a0dad; display: block;">(Récurrence mensuelle)</small>' : '';

    return `
      <li class="item-panier" data-id-item="${item.id}">
        <div class="item-panier-infos">
          <strong>Le ${dateFormatee} à ${item.startTime}</strong>
          ${recurrenceInfo}
          <small>${item.details}</small>
        </div>
        <div class="item-panier-actions">
            <span class="item-panier-prix">${item.prix.toFixed(2)} €</span>
            <button class="item-panier-supprimer" aria-label="Supprimer cet article">&times;</button>
        </div>
      </li>
    `;
  }).join('');

  const total = panier.reduce((acc, item) => acc + item.prix, 0);
  ui.panierTotalValeur.textContent = `~ ${total.toFixed(2)} €`; // Ajout de '~' car le total peut augmenter avec la récurrence
  ui.panierPiedDePage.classList.remove('hidden');
}

/**
 * Gère les actions dans le panier (ex: suppression d'un item).
 */
function gererActionsPanier(e) {
  if (e.target.classList.contains('item-panier-supprimer')) {
    const itemId = e.target.closest('.item-panier').dataset.idItem;
    window.etat.panier = window.etat.panier.filter(item => item.id !== itemId);
    afficherPanier();
    sauvegarderPanierDansLocalStorage();
    afficherNotification("Tournée retirée du panier.", "info");
  }
}

/**
 * Sauvegarde le panier dans le localStorage du navigateur.
 */
function sauvegarderPanierDansLocalStorage() {
  localStorage.setItem('panierReservationELS', JSON.stringify(window.etat.panier));
}

/**
 * Charge le panier depuis le localStorage au démarrage de l'application.
 */
function chargerPanierDepuisLocalStorage() {
  const panierSauvegarde = localStorage.getItem('panierReservationELS');
  if (panierSauvegarde) {
    window.etat.panier = JSON.parse(panierSauvegarde);
    afficherPanier();
  }
}
</script>
