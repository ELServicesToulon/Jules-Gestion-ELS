<script>
document.addEventListener('DOMContentLoaded', () => {
  const form   = document.getElementById('formulaire-connexion-client');
  const emailI = document.getElementById('email-connexion');
  const app    = document.getElementById('conteneur-app');
  const login  = document.getElementById('non-connecte');
  const msgBox = document.getElementById('message-connexion'); // un seul conteneur
  let inFlight = false;

  const setMsg = (t, type='info') => {
    if (!msgBox) return;
    msgBox.textContent = t;
    msgBox.className = `message-connexion ${type}`;
    msgBox.classList.remove('hidden');
  };

  // 1) Envoi du lien — UN seul écouteur (submit)
  form?.addEventListener('submit', (e) => {
    e.preventDefault();
    if (inFlight) return;
    inFlight = true;

    const email = (emailI?.value || '').trim().toLowerCase();
    if (!email) { inFlight = false; return setMsg("Adresse e-mail manquante.", "erreur"); }

    google.script.run
      .withSuccessHandler(ok => {
        inFlight = false;
        setMsg(ok ? "Un lien de connexion vient d’être envoyé."
                  : "Adresse inconnue. Vérifiez ou contactez l’admin.",
              ok ? "info" : "erreur");
      })
      .withFailureHandler(() => { inFlight = false; setMsg("Problème réseau, réessayez.", "erreur"); })
      .envoyerLienMagique(email);
  });

  // 2) Lecture du token dans le HASH, pas dans la query
  const url = new URL(window.location.href);
  const hashParams = new URLSearchParams((url.hash || '').replace(/^#/, ''));
  const token = hashParams.get('t');

  function nettoyerURL() {
    // On enlève le hash et on garde ?page=gestion
    const clean = url.pathname + (url.searchParams.get('page') ? `?page=${url.searchParams.get('page')}` : '');
    history.replaceState({}, '', clean);
  }

  if (token) {
    google.script.run
      .withSuccessHandler(email => {
        if (!email) { setMsg("Lien invalide ou expiré.", "erreur"); nettoyerURL(); return; }
        sessionStorage.setItem('ELS_client_email', email);
        nettoyerURL();
        login?.classList.add('hidden');
        app?.classList.remove('hidden');
        if (typeof chargerDonneesClient === 'function') chargerDonneesClient(email);
      })
      .withFailureHandler(() => { setMsg("Erreur de vérification du lien.", "erreur"); nettoyerURL(); })
      .verifierJetonMagique(token);
  } else {
    const saved = sessionStorage.getItem('ELS_client_email');
    if (saved) { login?.classList.add('hidden'); app?.classList.remove('hidden'); if (typeof chargerDonneesClient === 'function') chargerDonneesClient(saved); }
    else { login?.classList.remove('hidden'); app?.classList.add('hidden'); }
  }
});
</script>