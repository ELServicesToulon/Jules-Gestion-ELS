<script>
/**
 * =================================================================
 * MODULE JAVASCRIPT - GESTION DU CLIENT
 * =================================================================
 * Description: Gère la session client (localStorage) pour pré-remplir
 * les informations et personnaliser l'accueil.
 */

const CLE_LOCALSTORAGE_CLIENT = 'sessionClientELServices';

/**
 * Vérifie si une session client existe dans le localStorage.
 */
function verifierSessionClient() {
  const sessionSauvegardee = localStorage.getItem(CLE_LOCALSTORAGE_CLIENT);
  if (sessionSauvegardee) {
    const session = JSON.parse(sessionSauvegardee);
    window.etat.clientReconnu = session;
    preRemplirInfosClient(session.email);
  }
}

/**
 * Pré-remplit les informations du client s'il est reconnu.
 * @param {string} email L'email du client reconnu.
 */
function preRemplirInfosClient(email) {
    if(!email) return;

    const banniere = document.getElementById('banniere-client-reconnu');
    const nomClientEl = document.getElementById('nom-client-reconnu');

    basculerIndicateurChargement(true);
    google.script.run
        .withSuccessHandler(client => {
            basculerIndicateurChargement(false);
            if (client && window.ui) {
                if(window.ui.champEmailClient) window.ui.champEmailClient.value = client.email || '';
                if(window.ui.champNomClient) window.ui.champNomClient.value = client.nom || '';
                if(window.ui.champAdresseClient) window.ui.champAdresseClient.value = client.adresse || '';
                if(window.ui.champSiretClient) window.ui.champSiretClient.value = client.siret || '';

                if(nomClientEl) nomClientEl.textContent = client.nom;
                if(banniere) banniere.classList.remove('hidden');
            }
        })
        .withFailureHandler(afficherErreur)
        .rechercherClientParEmail(email);
}
/**
 * Réinitialise la session client et vide les champs.
 */
function reinitialiserClient() {
    localStorage.removeItem(CLE_LOCALSTORAGE_CLIENT);
    window.etat.clientReconnu = null;
    if (window.ui && window.ui.formulaireReservation) {
        window.ui.formulaireReservation.reset();
    }
    const banniere = document.getElementById('banniere-client-reconnu');
    if (banniere) {
        banniere.classList.add('hidden');
    }
}
</script>
