<div class="mlk-card">
  <h3 class="mlk-title">Lien direct d’accès client (admin)</h3>

  <div class="mlk-row">
    <label class="mlk-label">E-mail du client</label>
    <input type="email" class="mlk-input" data-mlk-email placeholder="client@exemple.fr">
  </div>

  <div class="mlk-actions">
    <button class="btn btn-pill" onclick="MLK_generate()">
      Générer le lien
    </button>
  </div>

  <div class="mlk-row" data-mlk-result style="display:none;">
    <label class="mlk-label">Lien généré</label>
    <input type="text" class="mlk-input" data-mlk-url readonly>
    <button class="mlk-copy" onclick="MLK_copy()">Copier le lien</button>
    <small class="mlk-help">
      ⚠️ Lien à usage unique. Si le client clique deux fois, le second essai sera refusé.
    </small>
  </div>

  <div class="mlk-toast" data-mlk-toast style="display:none;"></div>
</div>

<script>
(function(){
  window.MLK_generate = function(){
    const emailEl = document.querySelector('[data-mlk-email]');
    const resBox = document.querySelector('[data-mlk-result]');
    const urlEl   = document.querySelector('[data-mlk-url]');
    const toast   = document.querySelector('[data-mlk-toast]');
    const email = (emailEl && emailEl.value || '').trim();

    if (!email) { showToast('Saisis un e-mail valide.'); return; }

    google.script.run
      .withSuccessHandler(function(r){
        if (r && r.ok) {
          urlEl.value = r.url;
          resBox.style.display = '';
          showToast('Lien généré.');
        } else {
          showToast('Échec: ' + (r && r.error || '?'));
        }
      })
      .withFailureHandler(function(err){ showToast('Erreur serveur: ' + err); })
      .adminGenerateMagicLink(email);

    function showToast(msg){
      if (!toast) return;
      toast.textContent = msg;
      toast.style.display = 'block';
      clearTimeout(window.__mlk_to);
      window.__mlk_to = setTimeout(()=> toast.style.display = 'none', 3000);
    }
  };

  window.MLK_copy = async function(){
    const urlEl = document.querySelector('[data-mlk-url]');
    const toast = document.querySelector('[data-mlk-toast]');
    const text = (urlEl && urlEl.value) || '';
    if (!text) return;
    try {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        await navigator.clipboard.writeText(text);
      } else {
        // fallback
        urlEl.select(); document.execCommand('copy');
      }
      if (toast){ toast.textContent = 'Copié dans le presse-papiers.'; toast.style.display = 'block';
        clearTimeout(window.__mlk_to); window.__mlk_to = setTimeout(()=> toast.style.display = 'none', 2500); }
    } catch(e) {
      if (toast){ toast.textContent = 'Impossible de copier. Sélectionne le champ et copie manuellement.'; toast.style.display = 'block';
        clearTimeout(window.__mlk_to); window.__mlk_to = setTimeout(()=> toast.style.display = 'none', 3500); }
    }
  };
})();
</script>
