// # sourceURL=Reservation_JS.js
// =================================================================
// FICHIER JAVASCRIPT CONSOLIDÉ POUR L'INTERFACE DE RÉSERVATION
// =================================================================
// Ce fichier est une compilation de plusieurs modules JS.
// L'ordre de chargement est important pour la gestion des dépendances.
// =================================================================


// =================================================================
// MODULE: Reservation_JS_UI.html
// =================================================================
/**
 * Description: Gère les composants d'interface utilisateur génériques
 * comme les notifications, les messages d'erreur et
 * l'indicateur de chargement.
 */

/**
 * Affiche une notification animée à l'écran.
 * @param {string} message Le message à afficher.
 * @param {string} [type="info"] Le type de notification ('info', 'succes', 'erreur').
 */
function afficherNotification(message, type) {
  type = type || "info";
  const conteneur = document.getElementById('conteneur-notifications');
  if (!conteneur) {
    console.error("Le conteneur de notifications est introuvable.");
    return;
  }
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  notification.textContent = message;
  conteneur.appendChild(notification);

  // La notification disparaît automatiquement après 5 secondes.
  setTimeout(() => {
    notification.remove();
  }, 5000);
}

/**
 * Affiche ou masque l'indicateur de chargement global (spinner).
 * @param {boolean} afficher True pour afficher, false pour masquer.
 */
function basculerIndicateurChargement(afficher) {
  const indicateur = document.getElementById('indicateur-chargement');
  if (indicateur) {
    indicateur.classList.toggle('hidden', !afficher);
  } else {
    console.warn("L'élément 'indicateur-chargement' est introuvable dans le DOM.");
  }
}

/**
 * Gère l'affichage d'une erreur à l'utilisateur et dans la console.
 * @param {Object|string} erreur L'objet d'erreur ou le message à afficher.
 */
function afficherErreur(erreur) {
  basculerIndicateurChargement(false); // Toujours masquer le chargement en cas d'erreur.
  const messageErreur = typeof erreur === 'object' && erreur.message ? erreur.message : String(erreur);
  afficherNotification(`Erreur : ${messageErreur}`, "erreur");
  console.error(erreur);
}


// Ce bloc remplace l'ancienne logique par un point d'entrée simple
// qui s'appuie sur la "NOUVELLE LOGIQUE" ci-dessous.

// État global de l'application côté client
window.etat = {
  panier: [],
  clientReconnu: null,
};

// Fonctions de gestion du panier (génériques et utiles)
function afficherPanier() {
  const panier = window.etat.panier || [];
  const listePanier = document.getElementById('liste-panier');
  const panierPiedDePage = document.getElementById('panier-pied-de-page');
  const panierTotalValeur = document.getElementById('panier-total-valeur');

  if (!listePanier || !panierPiedDePage || !panierTotalValeur) return;

  if (panier.length === 0) {
    listePanier.innerHTML = '<p class="panier-vide">Votre panier est vide.</p>';
    panierPiedDePage.classList.add('hidden');
    return;
  }

  listePanier.innerHTML = panier.map(item => {
    const date = new Date(item.date + 'T00:00:00');
    const dateFormatee = date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long' });
    return `
      <li class="item-panier" data-id-item="${item.id}">
        <div class="item-panier-infos">
          <strong>Le ${dateFormatee} à ${item.startTime}</strong>
          <small>${item.details}</small>
        </div>
        <div class="item-panier-actions">
            <span class="item-panier-prix">${item.prix.toFixed(2)} €</span>
            <button class="item-panier-supprimer" aria-label="Supprimer cet article">&times;</button>
        </div>
      </li>
    `;
  }).join('');

  const total = panier.reduce((acc, item) => acc + item.prix, 0);
  panierTotalValeur.textContent = `${total.toFixed(2)} €`;
  panierPiedDePage.classList.remove('hidden');
}

function gererActionsPanier(e) {
  if (e.target.classList.contains('item-panier-supprimer')) {
    const itemId = e.target.closest('.item-panier').dataset.idItem;
    window.etat.panier = (window.etat.panier || []).filter(item => item.id !== itemId);
    afficherPanier();
    sauvegarderPanierDansLocalStorage();
    afficherNotification("Tournée retirée du panier.", "info");
  }
}

function sauvegarderPanierDansLocalStorage() {
  localStorage.setItem('panierReservationELS', JSON.stringify(window.etat.panier));
}

function chargerPanierDepuisLocalStorage() {
  const panierSauvegarde = localStorage.getItem('panierReservationELS');
  if (panierSauvegarde) {
    window.etat.panier = JSON.parse(panierSauvegarde);
  } else {
    window.etat.panier = [];
  }
  afficherPanier();
}

// Point d'entrée principal
document.addEventListener('DOMContentLoaded', () => {
  basculerIndicateurChargement(true);

  google.script.run
    .withSuccessHandler(result => {
      if (result && result.ok) {
        window.__TARIFS__ = result; // Contient .tarifs et .reservation

        const aujourdhui = new Date().toISOString();
        google.script.run
          .withSuccessHandler(planningResult => {
            initCalendrier(planningResult, result);
            basculerIndicateurChargement(false);
          })
          .withFailureHandler(err => {
            afficherErreur("Impossible de charger le planning: " + (err.message || err));
            basculerIndicateurChargement(false);
          })
          .getPlanningMois(aujourdhui);
      } else {
        const message = result && result.errors ? result.errors.join(', ') : "Format de réponse invalide.";
        afficherErreur("Erreur de configuration des tarifs: " + message);
        basculerIndicateurChargement(false);
      }
    })
    .withFailureHandler(err => {
      afficherErreur("Impossible de charger la configuration: " + (err.message || err));
      basculerIndicateurChargement(false);
    })
    .getTarifsPublic();

  // La gestion du panier peut être initialisée en parallèle
  chargerPanierDepuisLocalStorage();
  const listePanier = document.getElementById('liste-panier');
  if (listePanier) {
    listePanier.addEventListener('click', gererActionsPanier);
  }
});

// Global state for the calendar
let dateAffichee = new Date();

function initCalendrier(planning, cfg) {
  // Update the tariff cards on the page (this logic was in the old DOMContentLoaded)
  (function () {
    const tarifs = cfg.tarifs;
    if (!tarifs) return;

    const eBase    = document.getElementById('tarif-base');
    const eArrets  = document.getElementById('tarif-paliers');
    const eOptions = document.getElementById('tarif-options');

    const euros = (n) => (typeof n === 'number')
      ? new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(n)
      : '—';

    if (eBase) {
      eBase.textContent = `À partir de ${euros(tarifs.base)} la course.`;
    }
    if (eArrets) {
      const jusqua = tarifs.arrets.palier_max_inclus;
      eArrets.textContent = `+${euros(tarifs.arrets.prix_palier)} / arrêt jusqu'à ${jusqua}, puis +${euros(tarifs.arrets.prix_apres)}.`;
    }
    if (eOptions) {
        let optionsText = [];
        if (tarifs.options.urgence?.actif) optionsText.push(`Urgence +${euros(tarifs.options.urgence.surcharge)}`);
        if (tarifs.options.samedi?.actif) optionsText.push(`Samedi +${euros(tarifs.options.samedi.surcharge)}`);
        eOptions.textContent = optionsText.length > 0 ? optionsText.join(', ') : "Aucune option spéciale.";
    }
  })();


    const btnReserver = document.getElementById('btn-reserver');
    if (btnReserver) {
      btnReserver.addEventListener('click', () => openReservationModal(new Date().toISOString()));
    }

    // La logique d'ouverture de la modale `openReservationModal` est maintenant
    // attachée directement aux jours du calendrier dans `Reservation_Interface.html`.
    // Ce script n'a plus besoin de le faire.
});

  renderCalendrier(planning);

  // Attach event listeners for month navigation
  document.getElementById('btn-mois-precedent').onclick = () => changerMois(-1);
  document.getElementById('btn-mois-suivant').onclick = () => changerMois(1);
}

function renderCalendrier(planning) {
  const grille = document.getElementById('grille-calendrier');
  const titre = document.getElementById('titre-calendrier');
  grille.innerHTML = '';

  const annee = dateAffichee.getFullYear();
  const mois = dateAffichee.getMonth();

  titre.textContent = new Date(annee, mois).toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });

  const premierJourDuMois = new Date(annee, mois, 1).getDay();
  // Adjust to make Monday the first day of the week (0=Monday, 6=Sunday)
  const offset = (premierJourDuMois === 0) ? 6 : premierJourDuMois - 1;

  const nbJoursDansMois = new Date(annee, mois + 1, 0).getDate();

  // Add empty cells for the days before the first day of the month
  for (let i = 0; i < offset; i++) {
    grille.insertAdjacentHTML('beforeend', '<div class="jour-calendrier vide"></div>');
  }

  // Create a map of planning for quick lookup
  const planningMap = new Map(planning.map(p => [p.date, p.disponible]));

  // Add cells for each day of the month
  for (let i = 1; i <= nbJoursDansMois; i++) {
    const jourDate = new Date(annee, mois, i);
    const dateISO = jourDate.toISOString().slice(0, 10);
    const disponible = planningMap.get(dateISO) || false;

    const jourDiv = document.createElement('div');
    jourDiv.className = 'jour-calendrier';
    jourDiv.textContent = i;
    jourDiv.dataset.date = dateISO;

    if (disponible) {
      jourDiv.classList.add('disponible');
      jourDiv.onclick = () => openReservationModal(dateISO);
    } else {
      jourDiv.classList.add('indisponible');
    }

    // Highlight today
    const aujourdhui = new Date();
    if (jourDate.toDateString() === aujourdhui.toDateString()) {
      jourDiv.classList.add('aujourdhui');
    }

    grille.appendChild(jourDiv);
  }
}

function changerMois(delta) {
  dateAffichee.setMonth(dateAffichee.getMonth() + delta);
  basculerIndicateurChargement(true);

  google.script.run
    .withSuccessHandler(planningResult => {
      renderCalendrier(planningResult);
      basculerIndicateurChargement(false);
    })
    .withFailureHandler(err => {
      afficherErreur("Impossible de charger le planning pour le nouveau mois: " + (err.message || err));
      basculerIndicateurChargement(false);
    })
    .getPlanningMois(dateAffichee.toISOString());
}
 main


// =================================================================
// MODULE: NOUVELLE LOGIQUE POUR LA MODALE DE RÉSERVATION
// =================================================================

const DEF_RULES = {
  ALLOW_SAME_DAY: true,
  SAME_DAY_CUTOFF_HOUR: 12,
  MAX_ARRETS_VISIBLE: 12
};
const rules = () => (window.__TARIFS__ && window.__TARIFS__.reservation) ? window.__TARIFS__.reservation : DEF_RULES;

function showModalSkeleton() { basculerIndicateurChargement(true); }
function hideModalSkeleton() { basculerIndicateurChargement(false); }
function showSlotsSkeleton() { basculerIndicateurChargement(true); }
function hideSlotsSkeleton() { basculerIndicateurChargement(false); }
function showError(message) { afficherErreur(message); }

function computeWeekFromAnchor_(iso) {
  const anchor = iso ? new Date(iso) : new Date();
  const day = (anchor.getDay() + 6) % 7; // 0=lundi
  const monday = new Date(anchor); monday.setDate(anchor.getDate() - day);
  return Array.from({length:7}, (_,i)=> {
    const d = new Date(monday); d.setDate(monday.getDate()+i); d.setHours(0,0,0,0); return d;
  });
}
function stripTime_(d){ const x=new Date(d); x.setHours(0,0,0,0); return x; }
function isSameDay_(a,b){ return a.toDateString()===b.toDateString(); }
function selectChip_(btn, root){ root.querySelectorAll('.chip').forEach(c=>c.classList.remove('is-active')); btn.classList.add('is-active'); }


function openReservationModal(anchorISO) {
  const modal = document.getElementById('reservation-modal');
  modal.style.display = 'flex';
  document.body.style.overflow = 'hidden';

  window.closeReservationModal = function() {
    modal.style.display = 'none';
    document.body.style.overflow = '';
  };

  showModalSkeleton();

  const a_tarifs = window.__TARIFS__ && window.__TARIFS__.tarifs;
  if (!a_tarifs) {
    showError('La configuration ou les tarifs ne sont pas disponibles.');
    hydrateTarifCards(null); // Assure que l'UI reflète l'erreur
    hideModalSkeleton();
    return;
  }

  // Plus besoin de google.script.run, on utilise les données déjà présentes
  hydrateTarifCards(a_tarifs);
  buildDayChips(anchorISO);
  buildArretsSelect();
  wireModalEvents();
  hideModalSkeleton();
  refreshSlotsPreview_();
}

function hydrateTarifCards(tp){
  const boxBase   = document.getElementById('card-base');
  const boxStops  = document.getElementById('card-stops');
  const boxOpt    = document.getElementById('card-opts');
  const fail = !tp;

  if (fail){
    setCard(boxBase,  'Config vide ou invalide');
    setCard(boxStops, 'Config vide ou invalide');
    setCard(boxOpt,   'Config vide ou invalide');
    return;
  }

  const prix1 = tp.base;
  const inc2  = tp.arrets.prix_palier;
  const inc5  = tp.arrets.prix_apres;

  setCard(boxBase,  `${prix1.toFixed(2)} € HT la course de base`);
  setCard(boxStops, `+${inc2.toFixed(2)} € / arrêt (2→${tp.arrets.palier_max_inclus}), puis +${inc5.toFixed(2)} € au-delà`);
  setCard(boxOpt,   tp.options.retour_compte_comme_arret ? `Retour pharmacie = +1 arrêt` : `Retour pharmacie inclus`);

  function setCard(el, txt){ if(el) el.querySelector('.card-body').textContent = txt; }
}

function buildDayChips(weekAnchorISO){
  const root = document.getElementById('js-day-chips'); if(!root) return;
  root.innerHTML = '';

  const R = rules();
  const week = computeWeekFromAnchor_(weekAnchorISO);
  const now = new Date();

  const cutoff = (d) => {
    if (!R.ALLOW_SAME_DAY) return d > stripTime_(now);
    if (isSameDay_(d, now)) return now.getHours() < (R.SAME_DAY_CUTOFF_HOUR != null ? R.SAME_DAY_CUTOFF_HOUR : 12);
    return d >= stripTime_(now);
  };

  week.forEach(d => {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'chip';
    btn.textContent = String(d.getDate()).padStart(2, '0');
    btn.dataset.iso = d.toISOString().slice(0,10);

    if (!cutoff(d)) {
      btn.classList.add('is-disabled');
    }

    btn.onclick = () => {
      if (btn.classList.contains('is-disabled')) return;
      selectChip_(btn, root);
      refreshSlotsPreview_(); // Refresh slots when day changes
    };
    root.appendChild(btn);
  });

  const first = root.querySelector('.chip:not(.is-disabled)');
  if (first) {
    selectChip_(first, root);
  }
}

function buildArretsSelect(){
  const sel = document.getElementById('select-arrets'); if(!sel) return;
  const R = rules();
  const maxUI = Math.max(6, R.MAX_ARRETS_VISIBLE != null ? R.MAX_ARRETS_VISIBLE : 12);
  sel.innerHTML = '';
  for (let n=1;n<=maxUI;n++){
    const opt = document.createElement('option');
    opt.value = String(n);
    opt.textContent = (n<6) ? `${n} arrêt${n>1?'s':''}` : `${n}+ arrêts`;
    sel.appendChild(opt);
  }
}

async function refreshSlotsPreview_(){
  const active = document.querySelector('#js-day-chips .chip.is-active');
  if(!active) {
      const container = document.getElementById('slots-container');
      if (container) container.innerHTML = '';
      return;
  }

  const dayISO = active.dataset.iso;
  const nbPDL = parseInt(document.getElementById('select-arrets').value,10);

  // The new chargerCreneaux function will handle the skeleton (loading spinner)
  chargerCreneaux(dayISO, nbPDL);
}

function renderSlots_(slots) {
    const container = document.getElementById('slots-container');
    if (!container) return;

    container.innerHTML = '';

    if (!slots || slots.length === 0) {
        container.innerHTML = '<p style="text-align:center; margin: 1em 0;">Aucun créneau disponible pour cette configuration.</p>';
        return;
    }

    slots.forEach(slot => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.style.cssText = 'display: block; width: 100%; padding: 0.8em; margin-bottom: 0.5em; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9; text-align: left; cursor: pointer;';

        const urgentTag = slot.tags.includes('urgent') ? '<span style="color:red;">⚡ Urgent</span>' : '';
        const samediTag = slot.tags.includes('samedi') ? '<span style="color:purple;">🟪 Samedi</span>' : '';

        btn.innerHTML = `
            <div style="display:flex; justify-content: space-between; align-items: center;">
                <span style="font-weight: 600; font-size: 1.1em;">${slot.timeRange}</span>
                <span style="font-weight: 700; font-size: 1.1em;">${slot.basePrice.toFixed(2)} €</span>
            </div>
            <div style="font-size: 0.9em; margin-top: 0.3em;">${urgentTag} ${samediTag}</div>
        `;

        btn.onclick = () => {
            ajouterTourneeAuPanierSimple_(slot);
            closeReservationModal();
        };
        container.appendChild(btn);
    });
}

function ajouterTourneeAuPanierSimple_(slot) {
    const dayISO = document.querySelector('#js-day-chips .chip.is-active').dataset.iso;
    const totalStops = parseInt(document.getElementById('select-arrets').value, 10);
    const returnToPharmacy = document.getElementById('cb-retour').checked;
    const estimation = estimerInfosTournee(totalStops);

    const nouvelleTournee = {
        id: 'tournee-' + Date.now(),
        date: dayISO,
        startTime: slot.timeRange,
        totalStops: totalStops,
        returnToPharmacy: returnToPharmacy,
        prix: slot.basePrice,
        duree: estimation.duree,
        details: `Tournée de ${estimation.duree}min (${totalStops} arrêt(s), retour: ${returnToPharmacy ? 'oui' : 'non'})`,
        isRecurrent: false
    };

    window.etat.panier.push(nouvelleTournee);
    afficherPanier();
    sauvegarderPanierDansLocalStorage();
    afficherNotification("Tournée ajoutée au panier !", "succes");
}

function wireModalEvents() {
    // Add change listeners for dynamic slot refreshing
    document.getElementById('select-arrets').addEventListener('change', refreshSlotsPreview_);
    document.getElementById('cb-retour').addEventListener('change', refreshSlotsPreview_);

    // The submit button is now redundant, so we remove its handler to avoid confusion.
    const form = document.getElementById('formReservation');
    if (form) {
        form.onsubmit = (e) => e.preventDefault();
    }
}


async function chargerCreneaux(dayISO, nbPDL){
  google.script.run
    .withSuccessHandler(slots=>{
      // si slots.length === 0 => afficher “Indisponible” pour la journée
      // sinon, remplir la grille avec prix/km/min fournis par le serveur
      renderSlots_(slots); // adapt to existing function name
    })
    .withFailureHandler(err=>{
      console.error('getAvailableSlots failed', err);
      renderSlots_([]); // tout indispo visuellement
    })
    .getAvailableSlots(dayISO, nbPDL);
}
