// =================================================================
// FICHIER JAVASCRIPT CONSOLIDÉ POUR L'INTERFACE DE RÉSERVATION
// =================================================================
// Ce fichier est une compilation de plusieurs modules JS.
// L'ordre de chargement est important pour la gestion des dépendances.
// =================================================================


// =================================================================
// MODULE: Reservation_JS_UI.html
// =================================================================
/**
 * Description: Gère les composants d'interface utilisateur génériques
 * comme les notifications, les messages d'erreur et
 * l'indicateur de chargement.
 */

/**
 * Affiche une notification animée à l'écran.
 * @param {string} message Le message à afficher.
 * @param {string} [type="info"] Le type de notification ('info', 'succes', 'erreur').
 */
function afficherNotification(message, type = "info") {
  const conteneur = document.getElementById('conteneur-notifications');
  if (!conteneur) {
    console.error("Le conteneur de notifications est introuvable.");
    return;
  }
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  notification.textContent = message;
  conteneur.appendChild(notification);

  // La notification disparaît automatiquement après 5 secondes.
  setTimeout(() => {
    notification.remove();
  }, 5000);
}

/**
 * Affiche ou masque l'indicateur de chargement global (spinner).
 * @param {boolean} afficher True pour afficher, false pour masquer.
 */
function basculerIndicateurChargement(afficher) {
  const indicateur = document.getElementById('indicateur-chargement');
  if (indicateur) {
    indicateur.classList.toggle('hidden', !afficher);
  } else {
    console.warn("L'élément 'indicateur-chargement' est introuvable dans le DOM.");
  }
}

/**
 * Gère l'affichage d'une erreur à l'utilisateur et dans la console.
 * @param {Object|string} erreur L'objet d'erreur ou le message à afficher.
 */
function afficherErreur(erreur) {
  basculerIndicateurChargement(false); // Toujours masquer le chargement en cas d'erreur.
  const messageErreur = typeof erreur === 'object' && erreur.message ? erreur.message : String(erreur);
  afficherNotification(`Erreur : ${messageErreur}`, "erreur");
  console.error(erreur);
}


// =================================================================
// MODULE: Reservation_JS_UI_Elements.html
// =================================================================
/**
 * Description: Centralise toutes les références aux éléments du DOM
 * dans un objet global `window.ui` pour un accès facile et propre.
 * Ce script doit être chargé avant tous les autres scripts de logique.
 */

document.addEventListener('DOMContentLoaded', () => {
  window.ui = {
    // Indicateur de chargement
    indicateurChargement: document.getElementById('indicateur-chargement'),

    // Calendrier
    grilleCalendrier: document.getElementById('grille-calendrier'),
    titreCalendrier: document.getElementById('titre-calendrier'),
    btnMoisPrecedent: document.getElementById('btn-mois-precedent'),
    btnMoisSuivant: document.getElementById('btn-mois-suivant'),

    // Panier
    listePanier: document.getElementById('liste-panier'),
    panierPiedDePage: document.getElementById('panier-pied-de-page'),
    panierTotalValeur: document.getElementById('panier-total-valeur'),
    btnValiderPanier: document.getElementById('btn-valider-panier'),

    // Modale 1: Configuration de la tournée
    modaleConfigTournee: document.getElementById('modale-config-tournee'),
    titreModaleConfig: document.getElementById('modale-config-titre'),
    formulaireConfigTournee: document.getElementById('formulaire-config-tournee'),
    btnFermerConfigTournee: document.getElementById('btn-fermer-config-tournee'),
    btnAjouterArret: document.getElementById('btn-ajouter-arret'),
    btnRetirerArret: document.getElementById('btn-retirer-arret'),
    valeurArretsSup: document.getElementById('valeur-arrets-sup'),
    interrupteurRetour: document.getElementById('interrupteur-retour'),
    resumeConfigTournee: document.getElementById('resume-config-tournee'),

    // Modale 2: Sélection du créneau
    modaleSelectionCreneau: document.getElementById('modale-selection-creneau'),
    titreModaleSelection: document.getElementById('modale-selection-titre'),
    btnFermerSelectionCreneau: document.getElementById('btn-fermer-selection-creneau'),
    grilleSelectionCreneau: document.getElementById('grille-selection-creneau'),
    btnAjouterAuPanier: document.getElementById('btn-ajouter-au-panier'),
    btnModifierTournee: document.getElementById('btn-modifier-tournee'),

    // Récapitulatif dans la modale de sélection
    recapCreneauHeure: document.getElementById('recap-creneau-heure'),
    recapCreneauTarif: document.getElementById('recap-creneau-tarif'),
    recapCreneauPrix: document.getElementById('recap-creneau-prix'),

    // Conteneur de finalisation
    conteneurFinalisation: document.getElementById('conteneur-finalisation'),
    formulaireReservation: document.getElementById('formulaire-reservation'),
    btnAnnulerReservation: document.getElementById('btn-annuler-reservation'),

    // Champs Client
    champEmailClient: document.getElementById('client-email'),
    champNomClient: document.getElementById('client-nom'),
    champAdresseClient: document.getElementById('client-adresse'),
    champSiretClient: document.getElementById('client-siret'),
    champNoteReservation: document.getElementById('note-reservation'),
    banniereClientReconnu: document.getElementById('banniere-client-reconnu'),
    nomClientReconnu: document.getElementById('nom-client-reconnu'),
    btnChangerClient: document.getElementById('btn-changer-client')
  };
});


// =================================================================
// MODULE: Reservation_JS_Calendrier.html
// =================================================================
/**
 * Description: Gère l'affichage, la mise à jour et la navigation
 * du calendrier principal de réservation.
 */

function afficherCalendrier(mois, annee) {
  basculerIndicateurChargement(true);

  google.script.run
    .withSuccessHandler(donnees => {
      const { grilleCalendrier, titreCalendrier } = window.ui;

      if (donnees && donnees.disponibilite && grilleCalendrier && titreCalendrier) {
        window.etat.donneesCalendrier = donnees.disponibilite;
        grilleCalendrier.innerHTML = '';

        titreCalendrier.textContent = new Date(annee, mois - 1).toLocaleString('fr-FR', { month: 'long', year: 'numeric' });

        const premierJourDuMois = new Date(annee, mois - 1, 1).getDay();
        const joursDansLeMois = new Date(annee, mois, 0).getDate();
        const aujourdhui = new Date();
        aujourdhui.setHours(0, 0, 0, 0);

        // Ajoute des cellules vides pour le décalage du premier jour.
        for (let i = 0; i < (premierJourDuMois === 0 ? 6 : premierJourDuMois - 1); i++) {
          grilleCalendrier.appendChild(document.createElement('div'));
        }

        for (let jour = 1; jour <= joursDansLeMois; jour++) {
          const celluleJour = document.createElement('div');
          const date = new Date(annee, mois - 1, jour);
          const dateString = `${annee}-${String(mois).padStart(2, '0')}-${String(jour).padStart(2, '0')}`;
          // Utiliser un total par défaut pour la cohérence visuelle si non fourni
          const disponibilite = window.etat.donneesCalendrier[dateString] || { disponibles: 0, total: 8 };

          celluleJour.className = 'jour-capsule'; // Nouvelle classe pour le style "gélule"

          const estPasse = date < aujourdhui;
          const estDimanche = date.getDay() === 0;
          const estComplet = disponibilite.disponibles === 0;

          if (estPasse || estDimanche || estComplet) {
            celluleJour.classList.add('desactive');
            celluleJour.innerHTML = `<span class="jour-numero">${jour}</span><span class="jour-dispo">Indisponible</span>`;
          } else {
            celluleJour.dataset.date = dateString;
            celluleJour.setAttribute('aria-label', `${disponibilite.disponibles} sur ${disponibilite.total} créneaux disponibles`);

            const placesPrises = disponibilite.total - disponibilite.disponibles;
            // Le taux de remplissage est le pourcentage de places PRISES
            const tauxRemplissage = disponibilite.total > 0 ? (placesPrises / disponibilite.total) * 100 : 0;

            // Appliquer le dégradé dynamique suggéré
            const bg = `linear-gradient(to right, var(--couleur-primaire) ${tauxRemplissage}%, var(--couleur-secondaire) ${tauxRemplissage}%)`;
            celluleJour.style.background = bg;

            celluleJour.innerHTML = `
              <span class="jour-numero">${jour}</span>
              <span class="jour-dispo">${disponibilite.disponibles} / ${disponibilite.total}</span>
            `;
          }
          grilleCalendrier.appendChild(celluleJour);
        }
      } else {
        afficherErreur("Les données du calendrier n'ont pas pu être chargées.");
      }
      basculerIndicateurChargement(false);
    })
    .withFailureHandler(afficherErreur)
    .obtenirDonneesCalendrierPublic(mois, annee);
}


// =================================================================
// MODULE: Reservation_JS_Panier.html
// =================================================================
/**
 * Description: Gère l'ajout, la suppression et l'affichage des
 * tournées dans le panier du client.
 */

function ajouterTourneeAuPanier() {
  const { ui } = window;
  const { tourneeEnCours } = window.etat;
  const creneauSelectionneBtn = ui.grilleSelectionCreneau.querySelector('.slot-btn.selected');
  const estRecurrent = document.getElementById('interrupteur-recurrence').checked;

  if (!creneauSelectionneBtn) {
    afficherNotification("Veuillez sélectionner un créneau.", "erreur");
    return;
  }

  const nouvelleTournee = {
    id: 'tournee-' + Date.now(),
    date: tourneeEnCours.date,
    startTime: creneauSelectionneBtn.dataset.creneau,
    totalStops: tourneeEnCours.totalStops,
    returnToPharmacy: tourneeEnCours.returnToPharmacy,
    prix: parseFloat(creneauSelectionneBtn.dataset.prix),
    duree: tourneeEnCours.duree,
    details: `Tournée de ${tourneeEnCours.duree}min (${Math.max(0, tourneeEnCours.totalStops - 1)} arrêt(s) sup., retour: ${tourneeEnCours.returnToPharmacy ? 'oui' : 'non'})`,
    isRecurrent: estRecurrent
  };

  window.etat.panier.push(nouvelleTournee);

  afficherPanier();
  sauvegarderPanierDansLocalStorage();

  ui.modaleSelectionCreneau.classList.add('hidden');
  afficherNotification("Tournée ajoutée au panier !", "succes");
}

function afficherPanier() {
  const { ui } = window;
  const { panier } = window.etat;

  if (panier.length === 0) {
    ui.listePanier.innerHTML = '<p class="panier-vide">Votre panier est vide.</p>';
    ui.panierPiedDePage.classList.add('hidden');
    return;
  }

  ui.listePanier.innerHTML = panier.map(item => {
    const date = new Date(item.date + 'T00:00:00');
    const dateFormatee = date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long' });
    const recurrenceInfo = item.isRecurrent ? '<small style="color: #6a0dad; display: block;">(Récurrence mensuelle)</small>' : '';

    return `
      <li class="item-panier" data-id-item="${item.id}">
        <div class="item-panier-infos">
          <strong>Le ${dateFormatee} à ${item.startTime}</strong>
          ${recurrenceInfo}
          <small>${item.details}</small>
        </div>
        <div class="item-panier-actions">
            <span class="item-panier-prix">${item.prix.toFixed(2)} €</span>
            <button class="item-panier-supprimer" aria-label="Supprimer cet article">&times;</button>
        </div>
      </li>
    `;
  }).join('');

  const total = panier.reduce((acc, item) => acc + item.prix, 0);
  ui.panierTotalValeur.textContent = `~ ${total.toFixed(2)} €`;
  ui.panierPiedDePage.classList.remove('hidden');
}

function gererActionsPanier(e) {
  if (e.target.classList.contains('item-panier-supprimer')) {
    const itemId = e.target.closest('.item-panier').dataset.idItem;
    window.etat.panier = window.etat.panier.filter(item => item.id !== itemId);
    afficherPanier();
    sauvegarderPanierDansLocalStorage();
    afficherNotification("Tournée retirée du panier.", "info");
  }
}

function sauvegarderPanierDansLocalStorage() {
  localStorage.setItem('panierReservationELS', JSON.stringify(window.etat.panier));
}

function chargerPanierDepuisLocalStorage() {
  const panierSauvegarde = localStorage.getItem('panierReservationELS');
  if (panierSauvegarde) {
    window.etat.panier = JSON.parse(panierSauvegarde);
    afficherPanier();
  }
}


// =================================================================
// MODULE: Reservation_JS_Client.html
// =================================================================
/**
 * Description: Gère la session client (localStorage) pour pré-remplir
 * les informations et personnaliser l'accueil.
 */

const CLE_LOCALSTORAGE_CLIENT = 'sessionClientELServices';

function verifierSessionClient() {
  const sessionSauvegardee = localStorage.getItem(CLE_LOCALSTORAGE_CLIENT);
  if (sessionSauvegardee) {
    const session = JSON.parse(sessionSauvegardee);
    window.etat.clientReconnu = session;
    preRemplirInfosClient(session.email);
  }
}

function preRemplirInfosClient(email) {
    if(!email) return;

    const banniere = document.getElementById('banniere-client-reconnu');
    const nomClientEl = document.getElementById('nom-client-reconnu');

    basculerIndicateurChargement(true);
    google.script.run
        .withSuccessHandler(client => {
            basculerIndicateurChargement(false);
            if (client && window.ui) {
                if(window.ui.champEmailClient) window.ui.champEmailClient.value = client.email || '';
                if(window.ui.champNomClient) window.ui.champNomClient.value = client.nom || '';
                if(window.ui.champAdresseClient) window.ui.champAdresseClient.value = client.adresse || '';
                if(window.ui.champSiretClient) window.ui.champSiretClient.value = client.siret || '';

                if(nomClientEl) nomClientEl.textContent = client.nom;
                if(banniere) banniere.classList.remove('hidden');
            }
        })
        .withFailureHandler(afficherErreur)
        .rechercherClientParEmail(email);
}

function reinitialiserClient() {
    localStorage.removeItem(CLE_LOCALSTORAGE_CLIENT);
    window.etat.clientReconnu = null;
    if (window.ui && window.ui.formulaireReservation) {
        window.ui.formulaireReservation.reset();
    }
    const banniere = document.getElementById('banniere-client-reconnu');
    if (banniere) {
        banniere.classList.add('hidden');
    }
}


// =================================================================
// MODULE: Reservation_JS_Tournee.html
// =================================================================

// NOTE JULES: La logique de tarification a été centralisée côté serveur.
// La fonction `calculerInfosTourneeClient` a été supprimée.
// Seule une fonction d'estimation pour la durée et le KM est conservée pour la modale 1.

/**
 * Estime la durée et le kilométrage d'une tournée pour l'affichage dans la première modale.
 * Le calcul du PRIX est désormais fait côté serveur.
 * @param {number} totalStops Nombre total d'arrêts.
 * @returns {object} Un objet avec la durée et le kilométrage estimés.
 */
function estimerInfosTournee(totalStops) {
  if (!configServeur) {
    return { duree: 0, km: 0 };
  }
  const DUREE_BASE_NUM = parseInt(configServeur.DUREE_BASE, 10);
  const DUREE_ARRET_SUP_NUM = parseInt(configServeur.DUREE_ARRET_SUP, 10);
  const KM_BASE_NUM = parseInt(configServeur.KM_BASE, 10);
  const KM_ARRET_SUP_NUM = parseInt(configServeur.KM_ARRET_SUP, 10);
  const arretsSupplementaires = Math.max(0, totalStops - 1);
  const duree = DUREE_BASE_NUM + (arretsSupplementaires * DUREE_ARRET_SUP_NUM);
  const km = KM_BASE_NUM + (arretsSupplementaires * KM_ARRET_SUP_NUM);
  return { duree: duree, km: km };
}


function ouvrirConfigurationTournee(dateString) {
  const { ui } = window;
  const date = new Date(dateString + 'T00:00:00');
  const dateFormatee = date.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });
  window.etat.tourneeEnCours = { date: dateString, totalStops: 1, returnToPharmacy: false };
  ui.titreModaleConfig.textContent = `Configurer la tournée du ${dateFormatee}`;
  ui.valeurArretsSup.textContent = '1';
  ui.interrupteurRetour.checked = false;
  mettreAJourResumeTournee();
  ui.modaleConfigTournee.classList.remove('hidden');
}

function mettreAJourResumeTournee() {
  const { ui } = window;
  const totalStops = parseInt(ui.valeurArretsSup.textContent, 10);
  const returnToPharmacy = ui.interrupteurRetour.checked;
  window.etat.tourneeEnCours.totalStops = totalStops;
  window.etat.tourneeEnCours.returnToPharmacy = returnToPharmacy;

  // La fonction d'estimation ne calcule plus le prix, qui est maintenant variable.
  const estimation = estimerInfosTournee(totalStops);

  ui.resumeConfigTournee.innerHTML = `
    <div><span>Durée estimée</span><strong>${estimation.duree} min</strong></div>
    <div><span>Prix</span><strong>Variable</strong></div>
    <div><span>Distance</span><strong>~ ${estimation.km} km</strong></div>`;
}

/**
 * Affiche la seconde modale avec les créneaux et les tarifs reçus du serveur.
 * @param {Array<Object>} slots Un tableau d'objets créneau, chacun avec son prix et ses tags.
 */
function afficherSelectionCreneaux(slots) {
  const { ui } = window;
  const { tourneeEnCours } = window.etat;
  ui.modaleConfigTournee.classList.add('hidden');
  ui.titreModaleSelection.textContent = `Créneaux pour le ${new Date(tourneeEnCours.date + 'T00:00:00').toLocaleDateString('fr-FR', { day: 'numeric', month: 'long' })}`;

  if (!slots || slots.length === 0) {
    ui.grilleSelectionCreneau.innerHTML = '<p class="panier-vide">Aucun créneau disponible pour cette configuration.</p>';
  } else {
    ui.grilleSelectionCreneau.innerHTML = slots.map(slot => {
      // La logique de tarification a disparu. On utilise directement les données du serveur.
      const estUrgent = slot.tags.includes("urgence");
      const estSamedi = slot.tags.includes("samedi");

      let tagLabel = '';
      let tagClass = '';
      if (estUrgent) {
        tagLabel = '⚡ Urgence';
        tagClass = 'tag-urgence';
      } else if (estSamedi) {
        tagLabel = '🟪 Samedi';
        tagClass = 'tag-samedi';
      }

      // Le bouton affiche le prix final et stocke les données nécessaires.
      return `
        <button class="slot-btn ${estUrgent ? 'urgent' : ''}" data-creneau="${slot.timeRange}" data-prix="${slot.basePrice}" data-tarif-type="${tagLabel || 'Normal'}">
          <span class="slot-time">${slot.timeRange}</span>
          <span class="slot-price">${slot.basePrice.toFixed(2)} €</span>
          ${tagLabel ? `<span class="slot-tag ${tagClass}">${tagLabel}</span>` : ''}
        </button>`;
    }).join('');
  }

  reinitialiserRecapCreneau();
  if(ui.btnAjouterAuPanier) ui.btnAjouterAuPanier.disabled = true;
  ui.modaleSelectionCreneau.classList.remove('hidden');
  ui.grilleSelectionCreneau.onclick = function(e) {
    const target = e.target.closest('.slot-btn');
    if (target) {
      if (ui.grilleSelectionCreneau) {
        ui.grilleSelectionCreneau.querySelectorAll('.slot-btn').forEach(btn => btn.classList.remove('selected'));
      }
      target.classList.add('selected');
      if (ui.recapCreneauHeure) ui.recapCreneauHeure.textContent = target.dataset.creneau;
      if (ui.recapCreneauTarif) ui.recapCreneauTarif.textContent = target.dataset.tarifType;
      if (ui.recapCreneauPrix) ui.recapCreneauPrix.textContent = `${parseFloat(target.dataset.prix).toFixed(2)} €`;
      if (ui.btnAjouterAuPanier) ui.btnAjouterAuPanier.disabled = false;
    }
  };
}

function reinitialiserRecapCreneau() {
    const { ui } = window;
    if (ui.recapCreneauHeure) ui.recapCreneauHeure.textContent = '--:--';
    if (ui.recapCreneauTarif) ui.recapCreneauTarif.textContent = '--';
    if (ui.recapCreneauPrix) ui.recapCreneauPrix.textContent = '--.-- €';
}

function retourVersConfiguration() {
    const { ui } = window;
    ui.modaleSelectionCreneau.classList.add('hidden');
    ui.modaleConfigTournee.classList.remove('hidden');
}

function gererAjoutAuPanier() {
  const { ui } = window;
  const creneauSelectionneBtn = ui.grilleSelectionCreneau.querySelector('.slot-btn.selected');
  const estRecurrent = document.getElementById('interrupteur-recurrence').checked;
  if (!creneauSelectionneBtn) {
    afficherNotification("Veuillez sélectionner un créneau.", "erreur");
    return;
  }
  if (estRecurrent) {
    verifierEtAfficherConfirmationRecurrence();
  } else {
    ajouterTourneeAuPanier(false);
  }
}

function verifierEtAfficherConfirmationRecurrence() {
  basculerIndicateurChargement(true);
  const { tourneeEnCours } = window.etat;
  const creneauSelectionneBtn = document.querySelector('#grille-selection-creneau .slot-btn.selected');
  const itemDeBase = {
    date: tourneeEnCours.date,
    startTime: creneauSelectionneBtn.dataset.creneau,
    duree: tourneeEnCours.duree
  };
  google.script.run
    .withSuccessHandler(resultats => {
      basculerIndicateurChargement(false);
      if (resultats && resultats.length > 0) {
        afficherModaleConfirmationRecurrence(resultats);
      } else {
        afficherErreur("Aucune date future n'a été trouvée pour cette récurrence.");
      }
    })
    .withFailureHandler(afficherErreur)
    .verifierDisponibiliteRecurrence(itemDeBase);
}

function afficherModaleConfirmationRecurrence(resultats) {
  const modale = document.getElementById('modale-confirmation-recurrence');
  const listeUI = document.getElementById('liste-recurrence-details');
  modale.dataset.recurrenceData = JSON.stringify(resultats);
  listeUI.innerHTML = resultats.map(res => {
    let content = '';
    if (res.status === 'OK') {
      content = `<strong>${res.dateFormatee}</strong> à ${res.creneau} <span class="status-ok">✔ Disponible</span>`;
    } else {
      content = `<strong>${res.dateFormatee}</strong> - <span class="status-conflict">⚠ Conflit</span><br>
                 Créneau initial ${res.original} indisponible. Alternative proposée : <strong>${res.creneau || 'Aucune'}</strong>`;
    }
    return `<li class="${res.status === 'OK' ? '' : 'conflit'}">${content}</li>`;
  }).join('');
  modale.classList.remove('hidden');
}

function confirmerEtAjouterRecurrenceAuPanier() {
    const modale = document.getElementById('modale-confirmation-recurrence');
    const resultats = JSON.parse(modale.dataset.recurrenceData || '[]');
    resultats.forEach(res => {
        if (res.creneau) {
            ajouterTourneeAuPanier(true, res);
        }
    });
    modale.classList.add('hidden');
    afficherNotification("Tournées récurrentes ajoutées au panier.", "succes");
}

function ajouterTourneeAuPanier(isRecurrentItem = false, recurrenceData = null) {
  const { tourneeEnCours } = window.etat;
  const creneauSelectionneBtn = document.querySelector('#grille-selection-creneau .slot-btn.selected');
  let date, startTime, prix;
  if (isRecurrentItem && recurrenceData) {
    date = recurrenceData.dateISO;
    startTime = recurrenceData.creneau;
    const infos = calculerInfosTourneeClient(tourneeEnCours.totalStops, tourneeEnCours.returnToPharmacy, date, startTime);
    prix = infos.prix;
  } else {
    date = tourneeEnCours.date;
    startTime = creneauSelectionneBtn.dataset.creneau;
    prix = parseFloat(creneauSelectionneBtn.dataset.prix);
  }
  const nouvelleTournee = {
    id: 'tournee-' + Date.now() + Math.random(),
    date: date,
    startTime: startTime,
    totalStops: tourneeEnCours.totalStops,
    returnToPharmacy: tourneeEnCours.returnToPharmacy,
    prix: prix,
    duree: tourneeEnCours.duree,
    details: `Tournée de ${tourneeEnCours.duree}min (${Math.max(0, tourneeEnCours.totalStops - 1)} arrêt(s) sup., retour: ${tourneeEnCours.returnToPharmacy ? 'oui' : 'non'})`,
    isRecurrent: isRecurrentItem
  };
  window.etat.panier.push(nouvelleTournee);
  afficherPanier();
  sauvegarderPanierDansLocalStorage();
  if (!isRecurrentItem) {
      document.getElementById('modale-selection-creneau').classList.add('hidden');
      afficherNotification("Tournée ajoutée au panier !", "succes");
  }
}


// =================================================================
// MODULE: Reservation_JS_Reservation.html
// =================================================================

function gererDemandeDevis() {
  const { ui } = window;
  const { panier } = window.etat;

  if (panier.length === 0) {
    afficherNotification("Votre panier est vide.", "erreur");
    return;
  }

  let email = ui.champEmailClient?.value.trim();
  if (!email && window.etat.clientReconnu) {
      email = window.etat.clientReconnu.email;
  }

  if (email) {
    envoyerDevis(email);
  } else {
    const modale = document.getElementById('modale-email-devis');
    if (modale) {
        modale.classList.remove('hidden');
    }
  }
}

function envoyerDevis(email) {
    const { ui } = window;
    const { panier } = window.etat;

    basculerIndicateurChargement(true);

    const donneesDevis = {
        client: {
            email: email,
            nom: ui.champNomClient?.value.trim() || window.etat.clientReconnu?.nom || ''
        },
        items: panier
    };

    google.script.run
        .withSuccessHandler(reponse => {
            basculerIndicateurChargement(false);
            if (reponse.success) {
                afficherNotification(`Un devis a été envoyé à ${email}`, "succes");
            } else {
                afficherErreur(reponse.error || "L'envoi du devis a échoué.");
            }
        })
        .withFailureHandler(afficherErreur)
        .envoyerDevisParEmail(donneesDevis);
}

function afficherConteneurFinalisation() {
  const { ui } = window;
  const { clientReconnu } = window.etat;

  if (clientReconnu) {
    ui.champEmailClient.value = clientReconnu.email;
    ui.champNomClient.value = clientReconnu.nom;
    ui.champAdresseClient.value = clientReconnu.adresse || '';
    ui.champSiretClient.value = clientReconnu.siret || '';
    ui.champEmailClient.readOnly = true;
    ui.champNomClient.readOnly = true;
  } else {
    if (ui.formulaireReservation) ui.formulaireReservation.reset();
    ui.champEmailClient.readOnly = false;
    ui.champNomClient.readOnly = false;
  }

  ui.conteneurFinalisation.classList.remove('hidden');
  ui.champEmailClient.focus();
}

function gererSoumissionReservation(e) {
  e.preventDefault();
  const { ui } = window;
  const { panier } = window.etat;

  if (panier.length === 0) {
    afficherNotification("Votre panier est vide.", "erreur");
    return;
  }

  basculerIndicateurChargement(true);

  const donneesReservation = {
    client: {
      email: ui.champEmailClient.value.trim(),
      nom: ui.champNomClient.value.trim(),
      adresse: ui.champAdresseClient.value.trim(),
      siret: ui.champSiretClient.value.trim(),
      note: ui.champNoteReservation.value.trim()
    },
    items: panier
  };

  google.script.run
    .withSuccessHandler(reponse => {
      basculerIndicateurChargement(false);
      if (reponse.success) {
        afficherNotification("Réservation confirmée ! Un email vous a été envoyé.", "succes");
        window.etat.panier = [];
        sauvegarderPanierDansLocalStorage();
        afficherPanier();
        ui.conteneurFinalisation.classList.add('hidden');
        localStorage.setItem(CLE_LOCALSTORAGE_CLIENT, JSON.stringify(donneesReservation.client));
      } else {
        afficherErreur(reponse.summary || "Une erreur est survenue lors de la réservation.");
        if (reponse.failedItemIds && reponse.failedItemIds.length > 0) {
            window.etat.panier = window.etat.panier.filter(item => !reponse.failedItemIds.includes(item.id));
            sauvegarderPanierDansLocalStorage();
            afficherPanier();
        }
      }
    })
    .withFailureHandler(afficherErreur)
    .reserverPanier(donneesReservation);
}


// =================================================================
// MODULE: Reservation_JS_Principal.html
// =================================================================
/**
 * Description: Point d'entrée principal du script côté client.
 * Initialise l'état de l'application, configure les écouteurs
 * d'événements et lance l'affichage initial.
 */

window.etat = {
  dateActuelle: new Date(),
  panier: [],
  tourneeEnCours: {},
  clientReconnu: null
};

function gererDemandeCreneaux(e) {
  e.preventDefault();
  basculerIndicateurChargement(true);
  const { tourneeEnCours } = window.etat;

  // Calcule et stocke la durée pour que 'ajouterTourneeAuPanier' puisse l'utiliser.
  // C'est une petite duplication de logique (le serveur le fait aussi) mais elle est
  // isolée et évite de complexifier le passage de données depuis le serveur.
  if (window.configServeur) {
    const DUREE_BASE_NUM = parseInt(configServeur.DUREE_BASE, 10);
    const DUREE_ARRET_SUP_NUM = parseInt(configServeur.DUREE_ARRET_SUP, 10);
    const arretsSupplementaires = Math.max(0, tourneeEnCours.totalStops - 1);
    tourneeEnCours.duree = DUREE_BASE_NUM + (arretsSupplementaires * DUREE_ARRET_SUP_NUM);
  } else {
    tourneeEnCours.duree = 30; // Fallback si la config n'est pas chargée
  }

  // Récupère les autres courses du panier pour le même jour pour éviter les conflits
  const autresCoursesPanier = window.etat.panier
    .filter(item => item.date === tourneeEnCours.date)
    .map(item => ({ startTime: item.startTime, duree: item.duree }));

  // Appel de la nouvelle API backend qui gère la logique de tarification
  google.script.run
    .withSuccessHandler(slots => {
      basculerIndicateurChargement(false);
      afficherSelectionCreneaux(slots);
    })
    .withFailureHandler(afficherErreur)
    .getAvailableSlots(tourneeEnCours.date, tourneeEnCours.totalStops, autresCoursesPanier);
}

function configurerEcouteursEvenements() {
  const { ui } = window;

  ui.grilleCalendrier?.addEventListener('click', (e) => {
    const jourClique = e.target.closest('.jour-capsule');
    if (jourClique && !jourClique.classList.contains('desactive')) {
      const dateString = jourClique.dataset.date;
      if(dateString) {
        // Ouvre la nouvelle modale de réservation avec la date sélectionnée
        openReservationModal(dateString);
      }
    }
  });

  ui.btnMoisPrecedent?.addEventListener('click', () => changerMois(-1));
  ui.btnMoisSuivant?.addEventListener('click', () => changerMois(1));
  ui.formulaireConfigTournee?.addEventListener('submit', gererDemandeCreneaux);
  ui.btnFermerConfigTournee?.addEventListener('click', () => ui.modaleConfigTournee.classList.add('hidden'));
  ui.btnAjouterArret?.addEventListener('click', () => {
    ui.valeurArretsSup.textContent = parseInt(ui.valeurArretsSup.textContent) + 1;
    mettreAJourResumeTournee();
  });
  ui.btnRetirerArret?.addEventListener('click', () => {
    const valeur = parseInt(ui.valeurArretsSup.textContent);
    if (valeur > 1) {
      ui.valeurArretsSup.textContent = valeur - 1;
      mettreAJourResumeTournee();
    }
  });
  ui.interrupteurRetour?.addEventListener('change', mettreAJourResumeTournee);
  ui.btnFermerSelectionCreneau?.addEventListener('click', () => ui.modaleSelectionCreneau.classList.add('hidden'));
  ui.btnAjouterAuPanier?.addEventListener('click', gererAjoutAuPanier);
  ui.btnModifierTournee?.addEventListener('click', retourVersConfiguration);

  const modaleRecurrence = document.getElementById('modale-confirmation-recurrence');
  document.getElementById('btn-confirmer-recurrence')?.addEventListener('click', confirmerEtAjouterRecurrenceAuPanier);
  document.getElementById('btn-fermer-confirmation-recurrence')?.addEventListener('click', () => modaleRecurrence.classList.add('hidden'));
  document.getElementById('btn-annuler-recurrence')?.addEventListener('click', () => modaleRecurrence.classList.add('hidden'));

  ui.btnValiderPanier?.addEventListener('click', afficherConteneurFinalisation);
  document.getElementById('btn-envoyer-devis')?.addEventListener('click', gererDemandeDevis);
  ui.formulaireReservation?.addEventListener('submit', gererSoumissionReservation);
  ui.btnAnnulerReservation?.addEventListener('click', () => ui.conteneurFinalisation.classList.add('hidden'));
  ui.listePanier?.addEventListener('click', gererActionsPanier);

  const modaleEmailDevis = document.getElementById('modale-email-devis');
  document.getElementById('formulaire-email-devis')?.addEventListener('submit', (e) => {
      e.preventDefault();
      const emailInput = document.getElementById('email-pour-devis');
      if (emailInput && emailInput.value) {
          envoyerDevis(emailInput.value.trim());
          modaleEmailDevis.classList.add('hidden');
          emailInput.value = '';
      }
  });
  document.getElementById('btn-fermer-email-devis')?.addEventListener('click', () => {
      modaleEmailDevis.classList.add('hidden');
  });

  ui.champEmailClient?.addEventListener('blur', (e) => {
      if(e.target.value) {
          preRemplirInfosClient(e.target.value);
      }
  });
  ui.btnChangerClient?.addEventListener('click', reinitialiserClient);
}

document.addEventListener('DOMContentLoaded', () => {
  chargerPanierDepuisLocalStorage();
  verifierSessionClient();
  afficherCalendrier(window.etat.dateActuelle.getMonth() + 1, window.etat.dateActuelle.getFullYear());
  configurerEcouteursEvenements();
});

function changerMois(delta) {
    window.etat.dateActuelle.setMonth(window.etat.dateActuelle.getMonth() + delta);
    afficherCalendrier(window.etat.dateActuelle.getMonth() + 1, window.etat.dateActuelle.getFullYear());
}


// =================================================================
// MODULE: NOUVELLE LOGIQUE POUR LA MODALE DE RÉSERVATION
// =================================================================

let CFG = null;            // la conf complète (doit contenir REGLES)
let TARIFS_PUBLIC = null;  // la vue stable pour l’UI

const DEF_RULES = {
  ALLOW_SAME_DAY: true,
  SAME_DAY_CUTOFF_HOUR: 12,
  MAX_ARRETS_VISIBLE: 12
};
const rules = () => (CFG && CFG.REGLES) ? CFG.REGLES : DEF_RULES;

function showModalSkeleton() { basculerIndicateurChargement(true); }
function hideModalSkeleton() { basculerIndicateurChargement(false); }
function showSlotsSkeleton() { basculerIndicateurChargement(true); }
function hideSlotsSkeleton() { basculerIndicateurChargement(false); }
function showError(message) { afficherErreur(message); }

function computeWeekFromAnchor_(iso) {
  const anchor = iso ? new Date(iso) : new Date();
  const day = (anchor.getDay() + 6) % 7; // 0=lundi
  const monday = new Date(anchor); monday.setDate(anchor.getDate() - day);
  return Array.from({length:7}, (_,i)=> {
    const d = new Date(monday); d.setDate(monday.getDate()+i); d.setHours(0,0,0,0); return d;
  });
}
function stripTime_(d){ const x=new Date(d); x.setHours(0,0,0,0); return x; }
function isSameDay_(a,b){ return a.toDateString()===b.toDateString(); }
function selectChip_(btn, root){ root.querySelectorAll('.chip').forEach(c=>c.classList.remove('is-active')); btn.classList.add('is-active'); }


function openReservationModal(anchorISO) {
  const modal = document.getElementById('reservation-modal');
  modal.style.display = 'flex';
  document.body.style.overflow = 'hidden';

  window.closeReservationModal = function() {
    modal.style.display = 'none';
    document.body.style.overflow = '';
  };

  showModalSkeleton();
  google.script.run
    .withSuccessHandler(cfg => {
      CFG = cfg;
      if (!CFG || !CFG.TARIFS) {
        showError('Tarifs non chargés.');
        hydrateTarifCards(null);
        hideModalSkeleton();
        return;
      }

      google.script.run
        .withSuccessHandler(tp => {
          TARIFS_PUBLIC = tp;
          hydrateTarifCards(tp);

          buildDayChips(anchorISO);
          buildArretsSelect();
          wireModalEvents();
          hideModalSkeleton();
          refreshSlotsPreview_();
        })
        .withFailureHandler(err => {
            showError('Vue tarifs publics non chargée: ' + String(err));
            hydrateTarifCards(null);
            hideModalSkeleton();
        })
        .getTarifsPublic();
    })
    .withFailureHandler((err) => {
        showError('Configuration non chargée: ' + String(err));
        hydrateTarifCards(null);
        hideModalSkeleton();
    })
    .getConfiguration();
}

function hydrateTarifCards(tp){
  const boxBase   = document.getElementById('card-base');
  const boxStops  = document.getElementById('card-stops');
  const boxOpt    = document.getElementById('card-opts');
  const fail = !tp || tp.ok === false || !tp.tables || !tp.tables.Normal;

  if (fail){
    setCard(boxBase,  'Config vide ou invalide');
    setCard(boxStops, 'Config vide ou invalide');
    setCard(boxOpt,   'Config vide ou invalide');
    return;
  }

  const cum = tp.tables.Normal; // tableau [prix 1 arrêt, 2 arrêts, 3, 4, 5, 6+]
  const prix1 = cum[0];
  const inc2  = cum[1] - cum[0]; // surcoût 2e arrêt
  const inc5  = cum[4] - cum[3]; // surcoût 5e (vaut pour 6+ si grille en paliers)

  setCard(boxBase,  `${prix1.toFixed(2)} € HT la course de base`);
  setCard(boxStops, `+${inc2.toFixed(2)} € / arrêt (2→4), puis +${inc5.toFixed(2)} € à partir du 5ᵉ`);
  setCard(boxOpt,   tp.retourEquivArret ? `Retour pharmacie = +1 arrêt` : `Retour pharmacie inclus`);

  function setCard(el, txt){ if(el) el.querySelector('.card-body').textContent = txt; }
}

function buildDayChips(weekAnchorISO){
  const root = document.getElementById('js-day-chips'); if(!root) return;
  root.innerHTML = '';

  const R = rules();
  const week = computeWeekFromAnchor_(weekAnchorISO);
  const now = new Date();

  const cutoff = (d) => {
    if (!R.ALLOW_SAME_DAY) return d > stripTime_(now);
    if (isSameDay_(d, now)) return now.getHours() < (R.SAME_DAY_CUTOFF_HOUR ?? 12);
    return d >= stripTime_(now);
  };

  week.forEach(d => {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'chip';
    btn.textContent = String(d.getDate()).padStart(2, '0');
    btn.dataset.iso = d.toISOString().slice(0,10);

    if (!cutoff(d)) {
      btn.classList.add('is-disabled');
    }

    btn.onclick = () => {
      if (btn.classList.contains('is-disabled')) return;
      selectChip_(btn, root);
      refreshSlotsPreview_(); // Refresh slots when day changes
    };
    root.appendChild(btn);
  });

  const first = root.querySelector('.chip:not(.is-disabled)');
  if (first) {
    selectChip_(first, root);
  }
}

function buildArretsSelect(){
  const sel = document.getElementById('select-arrets'); if(!sel) return;
  const R = rules();
  const maxUI = Math.max(6, R.MAX_ARRETS_VISIBLE ?? 12);
  sel.innerHTML = '';
  for (let n=1;n<=maxUI;n++){
    const opt = document.createElement('option');
    opt.value = String(n);
    opt.textContent = (n<6) ? `${n} arrêt${n>1?'s':''}` : `${n}+ arrêts`;
    sel.appendChild(opt);
  }
}

async function refreshSlotsPreview_(){
  const active = document.querySelector('#js-day-chips .chip.is-active');
  if(!active) {
      const container = document.getElementById('slots-container');
      if (container) container.innerHTML = '';
      return;
  }

  const dayISO = active.dataset.iso;
  const nbPDL = parseInt(document.getElementById('select-arrets').value,10);

  // The new chargerCreneaux function will handle the skeleton (loading spinner)
  chargerCreneaux(dayISO, nbPDL);
}

function renderSlots_(slots) {
    const container = document.getElementById('slots-container');
    if (!container) return;

    container.innerHTML = '';

    if (!slots || slots.length === 0) {
        container.innerHTML = '<p style="text-align:center; margin: 1em 0;">Aucun créneau disponible pour cette configuration.</p>';
        return;
    }

    slots.forEach(slot => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.style.cssText = 'display: block; width: 100%; padding: 0.8em; margin-bottom: 0.5em; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9; text-align: left; cursor: pointer;';

        const urgentTag = slot.tags.includes('urgent') ? '<span style="color:red;">⚡ Urgent</span>' : '';
        const samediTag = slot.tags.includes('samedi') ? '<span style="color:purple;">🟪 Samedi</span>' : '';

        btn.innerHTML = `
            <div style="display:flex; justify-content: space-between; align-items: center;">
                <span style="font-weight: 600; font-size: 1.1em;">${slot.timeRange}</span>
                <span style="font-weight: 700; font-size: 1.1em;">${slot.basePrice.toFixed(2)} €</span>
            </div>
            <div style="font-size: 0.9em; margin-top: 0.3em;">${urgentTag} ${samediTag}</div>
        `;

        btn.onclick = () => {
            ajouterTourneeAuPanierSimple_(slot);
            closeReservationModal();
        };
        container.appendChild(btn);
    });
}

function ajouterTourneeAuPanierSimple_(slot) {
    const dayISO = document.querySelector('#js-day-chips .chip.is-active').dataset.iso;
    const totalStops = parseInt(document.getElementById('select-arrets').value, 10);
    const returnToPharmacy = document.getElementById('cb-retour').checked;
    const estimation = estimerInfosTournee(totalStops);

    const nouvelleTournee = {
        id: 'tournee-' + Date.now(),
        date: dayISO,
        startTime: slot.timeRange,
        totalStops: totalStops,
        returnToPharmacy: returnToPharmacy,
        prix: slot.basePrice,
        duree: estimation.duree,
        details: `Tournée de ${estimation.duree}min (${totalStops} arrêt(s), retour: ${returnToPharmacy ? 'oui' : 'non'})`,
        isRecurrent: false
    };

    window.etat.panier.push(nouvelleTournee);
    afficherPanier();
    sauvegarderPanierDansLocalStorage();
    afficherNotification("Tournée ajoutée au panier !", "succes");
}

function wireModalEvents() {
    // Add change listeners for dynamic slot refreshing
    document.getElementById('select-arrets').addEventListener('change', refreshSlotsPreview_);
    document.getElementById('cb-retour').addEventListener('change', refreshSlotsPreview_);

    // The submit button is now redundant, so we remove its handler to avoid confusion.
    const form = document.getElementById('formReservation');
    if (form) {
        form.onsubmit = (e) => e.preventDefault();
    }
}


// --- Fusion des initialisations ---
// Il y avait plusieurs 'DOMContentLoaded', je les fusionne en un seul pour plus de clarté.
document.addEventListener('DOMContentLoaded', () => {
    // Initialisation principale de l'application (partie 1)
    chargerPanierDepuisLocalStorage();
    verifierSessionClient();
    afficherCalendrier(window.etat.dateActuelle.getMonth() + 1, window.etat.dateActuelle.getFullYear());
    configurerEcouteursEvenements();

    chargerTarifsUI(); // NOUVEL APPEL

    // The button to open the modal is now handled inside configurerEcouteursEvenements
    // Let's add it there.
    const btnReserver = document.getElementById('btn-reserver');
    if (btnReserver) {
        btnReserver.onclick = function() {
            const today = new Date().toISOString().slice(0, 10);
            openReservationModal(today);
        };
    }
});

async function chargerTarifsUI(){
  try{
    google.script.run
      .withSuccessHandler((t)=>{
        if (!t || typeof t.baseCourse === 'undefined') return afficherTarifsManquants();
        const card = document.querySelector('#card-tarifs');
        if (!card) return; // Si la carte n'existe pas, on ne fait rien.

        card.querySelector('#tarif-base').textContent = t.baseCourse.toFixed(2) + " €";
        // Affiche la grille 2e..6e+
        const pal = [...t.PDL_PRIX, t.PDL_PRIX_FALLBACK + " (6e+)"];
        card.querySelector('#tarif-paliers').textContent = pal.join(' / ') + " €";
        card.querySelector('#tarif-options').textContent = `Urgence +${t.surcUrgence} €, Samedi +${t.surcSamedi} €`;
        card.classList.add('ok');
      })
      .withFailureHandler(err=>{
        console.error('getTarifsPublic failed', err);
        afficherTarifsManquants();
      })
      .getTarifsPublic();
  }catch(e){
    console.error(e); afficherTarifsManquants();
  }
}

function afficherTarifsManquants(){
  const card = document.querySelector('#card-tarifs');
  if (!card) return;
  card.querySelector('#tarif-base').textContent = "TARIFS manquant.";
  card.querySelector('#tarif-paliers').textContent = "—";
  card.querySelector('#tarif-options').textContent = "—";
  card.classList.remove('ok');
}

async function chargerCreneaux(dayISO, nbPDL){
  google.script.run
    .withSuccessHandler(slots=>{
      // si slots.length === 0 => afficher “Indisponible” pour la journée
      // sinon, remplir la grille avec prix/km/min fournis par le serveur
      renderSlots_(slots); // adapt to existing function name
    })
    .withFailureHandler(err=>{
      console.error('getAvailableSlots failed', err);
      renderSlots_([]); // tout indispo visuellement
    })
    .getAvailableSlots(dayISO, nbPDL);
}
