<script>
(function(){
  window.ELS = window.ELS || {};
  ELS.WEBAPP_URL = '<?= WEBAPP_URL ?>';
  ELS.SESSION_ID = '<?= SESSION_ID ?>';
  ELS.SESSION_EMAIL = '<?= SESSION_EMAIL ?>';

  function setSession(id){ try{ sessionStorage.setItem('ELS_SESSION', id); }catch(e){} }
  function getSession(){
    try{
      return sessionStorage.getItem('ELS_SESSION')
          || new URL(location.href).searchParams.get('session')
          || ELS.SESSION_ID || '';
    }catch(e){ return ELS.SESSION_ID || ''; }
  }
  function show(view){ document.documentElement.setAttribute('data-view', view); }

  window.ELS_signOut = function(){
    var sid = getSession();
    if (sid) google.script.run.destroySession(sid);
    try{ sessionStorage.removeItem('ELS_SESSION'); }catch(e){}
    const url = new URL(location.href);
    url.searchParams.delete('session'); url.searchParams.delete('auth');
    history.replaceState({},'',url);
    show('login');
  };

  document.addEventListener('DOMContentLoaded', function() {
    const params = new URLSearchParams(location.search);
    const authToken = params.get('auth');
    const sessionToken = params.get('session');
    const existingSessionId = getSession();

    const authOverlay = document.getElementById('auth-status-overlay');
    const authViews = {
        checking: document.getElementById('auth-view-checking'),
        success: document.getElementById('auth-view-success'),
        error: document.getElementById('auth-view-error')
    };

    function showAuthView(view) {
        if (authOverlay) authOverlay.classList.remove('hidden');
        for (const key in authViews) {
            if (authViews[key]) authViews[key].style.display = (key === view) ? 'block' : 'none';
        }
    }

    function hideAuthOverlay() {
        if (authOverlay) authOverlay.classList.add('hidden');
    }

    // --- Main Auth Flow ---

    // 1. If there's a magic link token, validate it. This is the highest priority.
    if (authToken) {
        showAuthView('checking');
        google.script.run
            .withSuccessHandler(function(res) {
                const url = new URL(location.href);
                url.searchParams.delete('auth');
                if (res && res.ok) {
                    showAuthView('success');
                    setSession(res.sessionId);
                    url.searchParams.set('session', res.sessionId);
                    history.replaceState({}, '', url);
                    setTimeout(() => {
                        hideAuthOverlay();
                        show('app');
                        if (typeof chargerDonneesClient === 'function') chargerDonneesClient(res.email);
                    }, 1500);
                } else {
                    history.replaceState({}, '', url);
                    showAuthView('error');
                    show('login'); // Show the login view behind the overlay
                }
            })
            .withFailureHandler(() => {
                showAuthView('error');
                show('login');
            })
            .validateMagicLinkAndCreateSession(authToken);
        return; // Stop further processing
    }

    // 2. If there's an existing session, validate it.
    const sessionId = existingSessionId || sessionToken;
    if (sessionId) {
        google.script.run
            .withSuccessHandler(function(res) {
                if (res && res.ok) {
                    setSession(sessionId);
                    show('app');
                    if (typeof chargerDonneesClient === 'function') chargerDonneesClient(res.email);
                } else {
                    show('login');
                }
            })
            .validateSessionServer(sessionId);
        return;
    }

    // 3. If the user is already logged into Google Apps Script context
    if (ELS.SESSION_EMAIL) {
        show('app');
        if (typeof chargerDonneesClient === 'function') chargerDonneesClient(ELS.SESSION_EMAIL);
        return;
    }

    // 4. If nothing else, show the login page.
    show('login');
  });

  window.ELS_requestLink = function(){
    const input = document.querySelector('[data-email]');
    const email = (input && input.value || '').trim();
    if (!email) return alert('Saisissez votre e-mail.');
    google.script.run.withSuccessHandler(function(r){
      if (r && r.ok) alert('Lien envoyé. Vérifiez le dossier Spam si besoin.');
      else alert('Envoi impossible (' + (r && r.error || '?') + ').');
    }).requestMagicLink(email);
  };
})();
</script>

<style>
  /* Toggle basique par attribut data-view */
  [data-view="login"] #view-app { display:none; }
  [data-view="login"] #view-login { display:block; }
  [data-view="app"] #view-login { display:none; }
  [data-view="app"] #view-app { display:block; }
</style>
